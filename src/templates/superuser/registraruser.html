{% extends 'superuser/dashboard.html' %}

{% block content %}
<main class="main-content">
  <div class="container">
    <h5 class="section-title mb-3">Registro de Dueño</h5>

    <!-- Tabs de navegación -->
    <ul class="nav nav-pills mb-3 tab-nav rounded-pill px-2 py-1 justify-content-center" id="pills-tab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active rounded-pill px-4" id="tab-personal" data-bs-toggle="pill"
          data-bs-target="#datos-personales" type="button" role="tab">Datos personales</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link rounded-pill px-4" id="tab-compania" data-bs-toggle="pill"
          data-bs-target="#datos-compania" type="button" role="tab">Datos de la compañía</button>
      </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content bg-white p-4 rounded-4 shadow-sm" id="pills-tabContent">

      <!-- Datos personales -->
      <div class="tab-pane fade show active" id="datos-personales" role="tabpanel">
        <form action="/registerperson" method="POST">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="rfc">RFC:</label>
              <input class="form-control custom-input" type="text" id="rfc" name="rfc" required>
            </div>
            <div class="col-md-4">
              <label for="nombre">Nombre:</label>
              <input class="form-control custom-input" type="text" id="nombre" name="nombre" required>
            </div>
            <div class="col-md-4">
              <label for="app">Apellido paterno:</label>
              <input class="form-control custom-input" type="text" id="app" name="app" required>
            </div>
            <div class="col-md-4">
              <label for="apm">Apellido materno:</label>
              <input class="form-control custom-input" type="text" id="apm" name="apm" required>
            </div>
            <div class="col-md-4">
              <label for="sexo">Sexo:</label>
              <select class="form-select custom-input" id="sexo" name="sexo" required>
                <option value="">Seleccionar</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="tel">Teléfono:</label>
              <input class="form-control custom-input" type="tel" id="tel" name="tel" required>
            </div>
            <div class="col-md-4">
              <label for="mail">Correo electrónico:</label>
              <input class="form-control custom-input" type="email" id="mail" name="mail" required>
            </div>
            <div class="col-md-4">
              <label for="rol">Rol:</label>
              <select class="form-select custom-input" id="rol" name="rol" required>
                <option value="">Seleccionar</option>
                <option value="1">Dueño</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="pais">País:</label>
              <select class="form-select custom-input" id="paises" name="paises" required onchange="selectPais()">
                <option value="" disabled selected>Selecciona el pais</option>
              </select>

            </div>
            <div class="col-md-4">
              <label for="estado">Estado:</label>
              <select class="form-select custom-input" id="estados" name="estados" required onchange="selectEstado()"
                hidden="true">
                <option value="" disabled selected>Selecciona el estado</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="municipio">Municipio:</label>
              <select class="form-select custom-input" id="municipios" name="municipios" required
                onchange="selectMunicipio()" hidden="true">
                <option value="" disabled selected>Selecciona el municipio</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="idcolonia">Colonia:</label>
              <select class="form-select custom-input" id="idcolonia" name="idcolonia" required hidden="true">
                <option value="" disabled selected>Selecciona la colonia</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="calle">Calle:</label>
              <input class="form-control custom-input" type="text" id="calle" name="calle" required>
            </div>
            <div class="col-md-4">
              <label for="numero">Número de calle:</label>
              <input class="form-control custom-input" type="text" id="numero" name="numero" required>
            </div>

            <div class="col-md-6">
              <label for="usuario">Usuario:</label>
              <input class="form-control custom-input" type="text" id="usuario" name="usuario" required>
            </div>
            <div class="col-md-6">
              <label for="password">Contraseña:</label>
              <input class="form-control custom-input" type="text" id="password" name="password" required>
            </div>
          </div>
          <div class="text-center mt-4">
            <button type="submit" class="btn btn-warning fw-bold px-5 py-2 rounded-pill">Guardar</button>
          </div>
        </form>
      </div>

      <!----------------------- Datos de la compañía ---------------------->
      <div class="tab-pane fade" id="datos-compania" role="tabpanel">
        <div class="bg-white p-4 rounded-4 shadow-sm">
          <form action="/registrarcompany" method="POST">
            <div class="row g-3">

              <div class="col-md-4">
                <label for="rfccomp">RFC de la compañía:</label>
                <input type="text" class="form-control custom-input" id="rfccomp" name="rfccomp" required>
              </div>

              <div class="col-md-4">
                <label for="nombre">Nombre:</label>
                <input type="text" class="form-control custom-input" id="nombre" name="nombre" required>
              </div>

              <div class="col-md-4">
                <label for="telefono">Teléfono:</label>
                <input type="text" class="form-control custom-input" id="telefono" name="telefono" required>
              </div>

              <div class="col-md-4">
                <label for="pais">País:</label>
                <select class="form-select custom-input" id="paises" name="paises" required onchange="selectPais()">
                  <option value="" selected>Selecciona el pais</option>
                </select>

              </div>
              <div class="col-md-4">
                <label for="estado">Estado:</label>
                <select class="form-select custom-input" id="estados" name="estados" required onchange="selectEstado()"
                  hidden="true">
                  <option value="" disabled selected>Selecciona el estado</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="municipio">Municipio:</label>
                <select class="form-select custom-input" id="municipios" name="municipios" required
                  onchange="selectMunicipio()" hidden="true">
                  <option value="" disabled selected>Selecciona el municipio</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="id_colonia">Colonia:</label>
                <select class="form-select custom-input" id="idcolonia" name="idcolonia" required hidden="true">
                  <option value="" disabled selected>Selecciona la colonia</option>
                </select>
              </div>

              <div class="col-md-4">
                <label for="calle">Calle:</label>
                <input type="text" class="form-control custom-input" id="calle" name="calle" required>
              </div>

              <div class="col-md-4">
                <label for="numero">Número:</label>
                <input type="text" class="form-control custom-input" id="numero" name="numero" required>
              </div>

              <div class="col-md-12">
                <label for="logo">Logo:</label>
                <input type="file" class="form-control custom-input" id="logo" name="logo" required>
              </div>

              <div class="text-center mt-4">
                <button type="submit" class="btn btn-warning fw-bold px-5 py-2 rounded-pill">Registrar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  // Función para inicializar los selects en todas las pestañas
  function initSelects(tabId = null) {
    // Identificar qué contenedor estamos usando
    const containers = tabId ? [document.getElementById(tabId)] : [
      document.getElementById('datos-personales'),
      document.getElementById('datos-compania')
    ];

    containers.forEach(container => {
      if (!container) return;

      // Buscar selects de países en este contenedor
      const paisesSelects = container.querySelectorAll('select[id="paises"]');

      paisesSelects.forEach(selectPais => {
        // Cargar países para este select
        fetch("/get-paises", { method: "GET" })
          .then(response => {
            if (!response.ok) {
              throw new Error("Error al cargar países: " + response.status);
            }
            return response.json();
          })
          .then(data => {
            console.log("Países cargados para", container.id, ":", data);
            // Limpiar opciones existentes excepto la primera
            selectPais.innerHTML = '<option value="" selected>Selecciona el país</option>';

            if (data && data.length > 0) {
              data.forEach(pais => {
                let option = document.createElement("option");
                option.value = pais.id;
                option.textContent = pais.nombre;
                selectPais.appendChild(option);
              });
            } else {
              console.warn("No se encontraron países");
            }
          })
          .catch(error => {
            console.error("Error al cargar países:", error);
          });
      });

      // Resetear los otros selects en este contenedor
      resetDependentSelects(container, 0);
    });
  }

  // Función para resetear selects dependientes dentro de un contenedor específico
  function resetDependentSelects(container, level = 0) {
    if (!container) return;

    // level: 0 = todos, 1 = desde estados, 2 = desde municipios, 3 = solo colonias
    if (level <= 1) {
      const selectsEst = container.querySelectorAll('select[id="estados"]');
      selectsEst.forEach(select => {
        select.innerHTML = '<option value="" disabled selected>Selecciona el estado</option>';
        select.hidden = true;
      });
    }

    if (level <= 2) {
      const selectsMun = container.querySelectorAll('select[id="municipios"]');
      selectsMun.forEach(select => {
        select.innerHTML = '<option value="" disabled selected>Selecciona el municipio</option>';
        select.hidden = true;
      });
    }

    if (level <= 3) {
      const selectsCol = container.querySelectorAll('select[id="idcolonia"]');
      selectsCol.forEach(select => {
        select.innerHTML = '<option value="" disabled selected>Selecciona la colonia</option>';
        select.hidden = true;
      });
    }
  }

  // Función para cargar estados según el país seleccionado
  function selectPais() {
    const selectElement = event.target; // Usar el evento para identificar qué select cambió
    const pais_id = selectElement.value;

    // Encontrar el contenedor padre (pestaña)
    const container = findParentTab(selectElement);
    if (!container) {
      console.error("No se pudo encontrar el contenedor padre");
      return;
    }

    // Resetear selects dependientes en este contenedor
    resetDependentSelects(container, 1);

    if (!pais_id) {
      console.warn("No se seleccionó ningún país");
      return;
    }

    fetch("/get-estados/" + pais_id, { method: "GET" })
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al cargar estados: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Estados cargados:", data);
        // Encontrar el select de estados en el mismo contenedor
        const selectEst = container.querySelector('select[id="estados"]');
        if (!selectEst) {
          console.error("No se encontró el select de estados en este contenedor");
          return;
        }

        selectEst.innerHTML = '<option value="" disabled selected>Selecciona el estado</option>';

        if (data && data.length > 0) {
          data.forEach(estado => {
            let option = document.createElement("option");
            option.value = estado.id;
            option.textContent = estado.nombre;
            selectEst.appendChild(option);
          });
          selectEst.hidden = false;
        } else {
          console.warn("No se encontraron estados para el país seleccionado");
        }
      })
      .catch(error => {
        console.error("Error al cargar estados:", error);
      });
  }

  // Función para cargar municipios según el estado seleccionado
  function selectEstado() {
    const selectElement = event.target; // Usar el evento para identificar qué select cambió
    const estado_id = selectElement.value;

    // Encontrar el contenedor padre (pestaña)
    const container = findParentTab(selectElement);
    if (!container) {
      console.error("No se pudo encontrar el contenedor padre");
      return;
    }

    // Resetear selects dependientes en este contenedor
    resetDependentSelects(container, 2);

    if (!estado_id) {
      console.warn("No se seleccionó ningún estado");
      return;
    }

    fetch("/get-municipios/" + estado_id, { method: "GET" })
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al cargar municipios: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Municipios cargados:", data);
        // Encontrar el select de municipios en el mismo contenedor
        const selectMun = container.querySelector('select[id="municipios"]');
        if (!selectMun) {
          console.error("No se encontró el select de municipios en este contenedor");
          return;
        }

        selectMun.innerHTML = '<option value="" disabled selected>Selecciona el municipio</option>';

        if (data && data.length > 0) {
          data.forEach(mun => {
            let option = document.createElement("option");
            option.value = mun.id;
            option.textContent = mun.nombre;
            selectMun.appendChild(option);
          });
          selectMun.hidden = false;
        } else {
          console.warn("No se encontraron municipios para el estado seleccionado");
        }
      })
      .catch(error => {
        console.error("Error al cargar municipios:", error);
      });
  }

  // Función para cargar colonias según el municipio seleccionado
  function selectMunicipio() {
    const selectElement = event.target; // Usar el evento para identificar qué select cambió
    const mun_id = selectElement.value;

    // Encontrar el contenedor padre (pestaña)
    const container = findParentTab(selectElement);
    if (!container) {
      console.error("No se pudo encontrar el contenedor padre");
      return;
    }

    // Resetear selects dependientes en este contenedor
    resetDependentSelects(container, 3);

    if (!mun_id) {
      console.warn("No se seleccionó ningún municipio");
      return;
    }

    fetch("/get-colonias/" + mun_id, { method: "GET" })
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al cargar colonias: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Colonias cargadas:", data);
        // Encontrar el select de colonias en el mismo contenedor
        const selectCol = container.querySelector('select[id="idcolonia"]');
        if (!selectCol) {
          console.error("No se encontró el select de colonias en este contenedor");
          return;
        }

        selectCol.innerHTML = '<option value="" disabled selected>Selecciona la colonia</option>';

        if (data && data.length > 0) {
          data.forEach(col => {
            let option = document.createElement("option");
            option.value = col.id;
            option.textContent = col.nombre;
            selectCol.appendChild(option);
          });
          selectCol.hidden = false;
        } else {
          console.warn("No se encontraron colonias para el municipio seleccionado");
        }
      })
      .catch(error => {
        console.error("Error al cargar colonias:", error);
      });
  }

  // Función auxiliar para encontrar el contenedor padre (tab-pane) de un elemento
  function findParentTab(element) {
    let current = element;
    while (current && !current.classList.contains('tab-pane')) {
      current = current.parentElement;
    }
    return current;
  }

  // Inicializar los selects al cargar la página
  document.addEventListener('DOMContentLoaded', function () {
    initSelects();

    // Agregar listeners para resetear el formulario
    document.querySelectorAll('form').forEach(form => {
      form.addEventListener('reset', function () {
        setTimeout(function () {
          const container = findParentTab(form);
          if (container) {
            initSelects(container.id);
          } else {
            initSelects();
          }
        }, 100);
      });
    });

    // Agregar listeners para cambios de pestaña
    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(tab => {
      tab.addEventListener('shown.bs.tab', function (e) {
        const targetId = e.target.getAttribute('data-bs-target').substring(1);
        initSelects(targetId);
      });
    });
  });

  // Función para manejar el envío del formulario con SweetAlert
  function addSwalAlertCre(id, endpoint, url_redir) {
    const form = document.getElementById(id);
    if (!form) {
      console.error("Formulario con ID", id, "no encontrado");
      return;
    }

    form.addEventListener("submit", function (event) {
      event.preventDefault();  // Evita que la página se recargue

      let formData = new FormData(this);

      fetch('/BP_SuperUserRoutes/registerperson', {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + (window.token || '')
        },
        body: formData
      })
        .then(response => {
          if (response.status === 401) {  // Si el token ha expirado
            return response.json().then(data => {
              Swal.fire({
                title: "Sesión expirada",
                text: data.error || "Tu sesión ha expirado. Por favor, inicia sesión nuevamente.",
                icon: "info",
                confirmButtonText: "Aceptar"
              }).then(() => {
                window.location.href = "/";  // Redirige después del alert
              });
            });
          } else if (response.status === 400) {  // Si es 400
            return response.json().then(data => {
              Swal.fire({
                title: "Un error ha ocurrido",
                text: data.error || "Error al procesar la solicitud",
                icon: "warning",
                confirmButtonText: "Aceptar"
              });
            });
          } else if (response.status === 200) {  // Si es 200
            return response.json().then(data => {
              form.reset();
              const container = findParentTab(form);
              if (container) {
                initSelects(container.id);
              } else {
                initSelects();
              }
              Swal.fire({
                title: "Registro exitoso",
                text: data.msg || "Operación completada con éxito",
                icon: "success",
                confirmButtonText: "Aceptar"
              });
            });
          } else {
            console.error("Respuesta inesperada:", response.status);
            Swal.fire({
              title: "Error",
              text: "Ocurrió un error inesperado",
              icon: "error",
              confirmButtonText: "Aceptar"
            });
          }
        })
        .catch(error => {
          console.error("Error en la solicitud:", error);
          Swal.fire({
            title: "Error de conexión",
            text: "No se pudo conectar con el servidor",
            icon: "error",
            confirmButtonText: "Aceptar"
          });
        });
    });
  }

  // Inicializar el manejador de formularios si existe
  if (document.getElementById("regForm")) {
    addSwalAlertCre("regForm", "/create_owner");
  }
</script>

{% endblock %}