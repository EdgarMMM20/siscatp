{% extends 'superuser/dashboard.html' %}
{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>
{% endblock %}
{% block content %}
<main class="main-content"> 
  
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Registro de Dueño y Compañía</h4>
        </div>
        <div class="card-body">
          <!-- Barra de progreso -->
          <div class="progress mb-4">
            <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 50%"
              aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">Paso 1 de 2</div>
          </div>

          <!-- Pestañas de navegación -->
          <ul class="nav nav-tabs" id="formTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active rounded-pill px-4" id="tab-personal" data-bs-toggle="pill"
                data-bs-target="#datos-personales" type="button" role="tab">Datos personales</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link rounded-pill px-4" id="tab-compania" data-bs-toggle="pill"
                data-bs-target="#datos-compania" type="button" role="tab">Datos de la compañía</button>
            </li>
          </ul>

          <!-- Contenido de las pestañas -->
          <div class="tab-content bg-white p-4 rounded-4 shadow-sm" id="pills-tabContent">

            <!-- Datos personales -->
            <div class="tab-pane fade show active" id="datos-personales" role="tabpanel">
              <form id="ownerForm" action="/registerperson" method="POST">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label for="owner_rfc">RFC:</label>
                    <input class="form-control custom-input" type="text" id="owner_rfc" name="rfc" required>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_nombre">Nombre:</label>
                    <input class="form-control custom-input" type="text" id="owner_nombre" name="nombre" required>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_app">Apellido paterno:</label>
                    <input class="form-control custom-input" type="text" id="owner_app" name="app" required>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_apm">Apellido materno:</label>
                    <input class="form-control custom-input" type="text" id="owner_apm" name="apm" required>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_sexo">Sexo:</label>
                    <select class="form-select custom-input" id="owner_sexo" name="sexo" required>
                      <option value="">Seleccionar</option>
                      <option value="M">Masculino</option>
                      <option value="F">Femenino</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_tel">Teléfono:</label>
                    <input class="form-control custom-input" type="tel" id="owner_tel" name="tel" required>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_mail">Correo electrónico:</label>
                    <input class="form-control custom-input" type="email" id="owner_mail" name="mail" required>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_rol">Rol:</label>
                    <select class="form-select custom-input" id="owner_rol" name="rol" required>
                      <option value="">Seleccionar</option>
                      <option value="1">Dueño</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_paises">País:</label>
                    <select class="form-select custom-input" id="owner_paises" name="paises" required
                      onchange="selectPais(event)">
                      <option value="" disabled selected>Selecciona el pais</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_estados">Estado:</label>
                    <select class="form-select custom-input" id="owner_estados" name="estados" required
                      onchange="selectEstado(event)" hidden="true">
                      <option value="" disabled selected>Selecciona el estado</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_municipios">Municipio:</label>
                    <select class="form-select custom-input" id="owner_municipios" name="municipios" required
                      onchange="selectMunicipio(event)" hidden="true">
                      <option value="" disabled selected>Selecciona el municipio</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_idcolonia">Colonia:</label>
                    <select class="form-select custom-input" id="owner_idcolonia" name="idcolonia" required
                      hidden="true">
                      <option value="" disabled selected>Selecciona la colonia</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_calle">Calle:</label>
                    <input class="form-control custom-input" type="text" id="owner_calle" name="calle" required>
                  </div>
                  <div class="col-md-4">
                    <label for="owner_numero">Número de calle:</label>
                    <input class="form-control custom-input" type="text" id="owner_numero" name="numero" required>
                  </div>

                  <div class="col-md-6">
                    <label for="owner_usuario">Usuario:</label>
                    <input class="form-control custom-input" type="text" id="owner_usuario" name="usuario" required>
                  </div>
                  <div class="col-md-6">
                    <label for="owner_password">Contraseña:</label>
                    <input class="form-control custom-input" type="password" id="owner_password" name="password"
                      required>
                  </div>
                </div>
                <div class="text-center mt-4">
                  <button type="submit" class="btn btn-warning fw-bold px-5 py-2 rounded-pill">Guardar</button>
                </div>
              </form>
            </div>

            <!----------------------- Datos de la compañía ---------------------->
            <div class="tab-pane fade" id="datos-compania" role="tabpanel">
              <form id="companyForm" action="/registrarcompany" method="POST" enctype="multipart/form-data">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label for="comp_rfccomp">RFC de la compañía:</label>
                    <input type="text" class="form-control custom-input" id="comp_rfccomp" name="rfccomp" required>
                  </div>

                  <div class="col-md-4">
                    <label for="comp_nombre">Nombre:</label>
                    <input type="text" class="form-control custom-input" id="comp_nombre" name="nombre" required>
                  </div>

                  <div class="col-md-4">
                    <label for="comp_telefono">Teléfono:</label>
                    <input type="text" class="form-control custom-input" id="comp_telefono" name="telefono" required>
                  </div>

                  <div class="col-md-4">
                    <label for="comp_paises">País:</label>
                    <select class="form-select custom-input" id="comp_paises" name="paises" required
                      onchange="selectPais(event)">
                      <option value="" selected>Selecciona el pais</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="comp_estados">Estado:</label>
                    <select class="form-select custom-input" id="comp_estados" name="estados" required
                      onchange="selectEstado(event)" hidden="true">
                      <option value="" disabled selected>Selecciona el estado</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="comp_municipios">Municipio:</label>
                    <select class="form-select custom-input" id="comp_municipios" name="municipios" required
                      onchange="selectMunicipio(event)" hidden="true">
                      <option value="" disabled selected>Selecciona el municipio</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="comp_idcolonia">Colonia:</label>
                    <select class="form-select custom-input" id="comp_idcolonia" name="idcolonia" required
                      hidden="true">
                      <option value="" disabled selected>Selecciona la colonia</option>
                    </select>
                  </div>

                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label for="comp_calle" class="form-label">Calle:</label>
                      <input type="text" class="form-control custom-input" id="comp_calle" name="calle" required>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label for="comp_numero" class="form-label">Número:</label>
                      <input type="text" class="form-control custom-input" id="comp_numero" name="numero" required>
                    </div>
                    <div class="col-md-12 mb-3">
                      <label for="comp_logo" class="form-label">Logo:</label>
                      <input type="file" class="form-control custom-input" id="comp_logo" name="logo">
                    </div>
                    <div class="col-12 text-center mt-4">
                      <button type="submit" class="btn btn-warning fw-bold px-5 py-2 rounded-pill">Registrar</button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

<script>
  src = "https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"

  // Función para inicializar los selects en todas las pestañas
  function initSelects(tabId = null) {
    // Identificar qué contenedor estamos usando
    const containers = tabId ? [document.getElementById(tabId)] : [
      document.getElementById('datos-personales'),
      document.getElementById('datos-compania')
    ];

    containers.forEach(container => {
      if (!container) return;

      // Buscar selects de países en este contenedor
      // Modificado para usar selectores más específicos
      const paisesSelect = container.querySelector('select[name="paises"]');

      if (paisesSelect) {
        // Cargar países para este select
        fetch("/get-paises", { method: "GET" })
          .then(response => {
            if (!response.ok) {
              throw new Error("Error al cargar países: " + response.status);
            }
            return response.json();
          })
          .then(data => {
            console.log("Países cargados para", container.id, ":", data);
            // Limpiar opciones existentes excepto la primera
            paisesSelect.innerHTML = '<option value="" selected>Selecciona el país</option>';

            if (data && data.length > 0) {
              data.forEach(pais => {
                let option = document.createElement("option");
                option.value = pais.id;
                option.textContent = pais.nombre;
                paisesSelect.appendChild(option);
              });
            } else {
              console.warn("No se encontraron países");
            }
          })
          .catch(error => {
            console.error("Error al cargar países:", error);
          });
      }

      // Resetear los otros selects en este contenedor
      resetDependentSelects(container, 0);
    });
  }

  // Función para resetear selects dependientes dentro de un contenedor específico
  function resetDependentSelects(container, level = 0) {
    if (!container) return;

    // level: 0 = todos, 1 = desde estados, 2 = desde municipios, 3 = solo colonias
    if (level <= 1) {
      const selectsEst = container.querySelector('select[name="estados"]');
      if (selectsEst) {
        selectsEst.innerHTML = '<option value="" disabled selected>Selecciona el estado</option>';
        selectsEst.hidden = true;
      }
    }

    if (level <= 2) {
      const selectsMun = container.querySelector('select[name="municipios"]');
      if (selectsMun) {
        selectsMun.innerHTML = '<option value="" disabled selected>Selecciona el municipio</option>';
        selectsMun.hidden = true;
      }
    }

    if (level <= 3) {
      const selectsCol = container.querySelector('select[name="idcolonia"]');
      if (selectsCol) {
        selectsCol.innerHTML = '<option value="" disabled selected>Selecciona la colonia</option>';
        selectsCol.hidden = true;
      }
    }
  }

  // Función para cargar estados según el país seleccionado
  function selectPais(event) {
    const selectElement = event.target; // Usar el evento para identificar qué select cambió
    const pais_id = selectElement.value;

    // Encontrar el contenedor padre (pestaña)
    const container = findParentTab(selectElement);
    if (!container) {
      console.error("No se pudo encontrar el contenedor padre");
      return;
    }

    // Resetear selects dependientes en este contenedor
    resetDependentSelects(container, 1);

    if (!pais_id) {
      console.warn("No se seleccionó ningún país");
      return;
    }

    fetch("/get-estados/" + pais_id, { method: "GET" })
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al cargar estados: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Estados cargados:", data);
        // Encontrar el select de estados en el mismo contenedor
        const selectEst = container.querySelector('select[name="estados"]');
        if (!selectEst) {
          console.error("No se encontró el select de estados en este contenedor");
          return;
        }

        selectEst.innerHTML = '<option value="" disabled selected>Selecciona el estado</option>';

        if (data && data.length > 0) {
          data.forEach(estado => {
            let option = document.createElement("option");
            option.value = estado.id;
            option.textContent = estado.nombre;
            selectEst.appendChild(option);
          });
          selectEst.hidden = false;
        } else {
          console.warn("No se encontraron estados para el país seleccionado");
        }
      })
      .catch(error => {
        console.error("Error al cargar estados:", error);
      });
  }

  // Función para cargar municipios según el estado seleccionado
  function selectEstado(event) {
    const selectElement = event.target; // Usar el evento para identificar qué select cambió
    const estado_id = selectElement.value;

    // Encontrar el contenedor padre (pestaña)
    const container = findParentTab(selectElement);
    if (!container) {
      console.error("No se pudo encontrar el contenedor padre");
      return;
    }

    // Resetear selects dependientes en este contenedor
    resetDependentSelects(container, 2);

    if (!estado_id) {
      console.warn("No se seleccionó ningún estado");
      return;
    }

    fetch("/get-municipios/" + estado_id, { method: "GET" })
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al cargar municipios: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Municipios cargados:", data);
        // Encontrar el select de municipios en el mismo contenedor
        const selectMun = container.querySelector('select[name="municipios"]');
        if (!selectMun) {
          console.error("No se encontró el select de municipios en este contenedor");
          return;
        }

        selectMun.innerHTML = '<option value="" disabled selected>Selecciona el municipio</option>';

        if (data && data.length > 0) {
          data.forEach(mun => {
            let option = document.createElement("option");
            option.value = mun.id;
            option.textContent = mun.nombre;
            selectMun.appendChild(option);
          });
          selectMun.hidden = false;
        } else {
          console.warn("No se encontraron municipios para el estado seleccionado");
        }
      })
      .catch(error => {
        console.error("Error al cargar municipios:", error);
      });
  }

  // Función para cargar colonias según el municipio seleccionado
  function selectMunicipio(event) {
    const selectElement = event.target; // Usar el evento para identificar qué select cambió
    const mun_id = selectElement.value;

    // Encontrar el contenedor padre (pestaña)
    const container = findParentTab(selectElement);
    if (!container) {
      console.error("No se pudo encontrar el contenedor padre");
      return;
    }

    // Resetear selects dependientes en este contenedor
    resetDependentSelects(container, 3);

    if (!mun_id) {
      console.warn("No se seleccionó ningún municipio");
      return;
    }

    fetch("/get-colonias/" + mun_id, { method: "GET" })
      .then(response => {
        if (!response.ok) {
          throw new Error("Error al cargar colonias: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Colonias cargadas:", data);
        // Encontrar el select de colonias en el mismo contenedor
        const selectCol = container.querySelector('select[name="idcolonia"]');
        if (!selectCol) {
          console.error("No se encontró el select de colonias en este contenedor");
          return;
        }

        selectCol.innerHTML = '<option value="" disabled selected>Selecciona la colonia</option>';

        if (data && data.length > 0) {
          data.forEach(col => {
            let option = document.createElement("option");
            option.value = col.id;
            option.textContent = col.nombre;
            selectCol.appendChild(option);
          });
          selectCol.hidden = false;
        } else {
          console.warn("No se encontraron colonias para el municipio seleccionado");
        }
      })
      .catch(error => {
        console.error("Error al cargar colonias:", error);
      });
  }

  // Función auxiliar para encontrar el contenedor padre (tab-pane) de un elemento
  function findParentTab(element) {
    let current = element;
    while (current && !current.classList.contains('tab-pane')) {
      current = current.parentElement;
    }
    return current;
  }

  // Función para manejar la presentación de formularios con SweetAlert
  function setupFormHandler(formId, endpoint, nextTabId) {
    const form = document.getElementById(formId);
    if (!form) {
      console.error("Formulario con ID", formId, "no encontrado");
      return;
    }

    form.addEventListener("submit", function (event) {
      event.preventDefault();

      let formData = new FormData(this);

      fetch(endpoint, {
        method: "POST",
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              title: "Registro exitoso",
              text: data.msg || "Operación completada con éxito",
              icon: "success",
              confirmButtonText: "Aceptar"
            }).then(() => {
              // Si hay un siguiente paso, avanzar
              if (nextTabId) {
                // Actualizar la barra de progreso
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                  progressBar.style.width = '100%';
                  progressBar.textContent = 'Paso 2 de 2';
                }

                // Cambiar a la siguiente pestaña
                const nextTab = document.querySelector(nextTabId);
                if (nextTab) {
                  bootstrap.Tab.getOrCreateInstance(nextTab).show();
                }
              }
            });
          } else {
            Swal.fire({
              title: "Error",
              text: data.error || "Ocurrió un error inesperado",
              icon: "error",
              confirmButtonText: "Aceptar"
            });
          }
        })
        .catch(error => {
          console.error("Error en la petición:", error);
          Swal.fire({
            title: "Error de conexión",
            text: "No se pudo conectar con el servidor",
            icon: "error",
            confirmButtonText: "Aceptar"
          });
        });
    });
  }

  // Inicializar al cargar la página
  document.addEventListener('DOMContentLoaded', function () {
    // Inicializar selects
    initSelects();

    // Configurar manejadores de formularios
    setupFormHandler("ownerForm", "/registerperson", "#tab-compania");
    setupFormHandler("companyForm", "/registrarcompany", null);

    // Agregar listeners para cambios de pestaña
    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(tab => {
      tab.addEventListener('shown.bs.tab', function (e) {
        const targetId = e.target.getAttribute('data-bs-target').substring(1);
        initSelects(targetId);
      });
    });
  });
</script>
</main>
{% endblock %}